<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cập nhật sản phẩm</title>
  <!-- Gọi config.js từ thư mục cha -->
  <script src="../js/config.js"></script>
  <script>document.write(`<base href="${BASE_URL}">`);</script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1b1b1b;
      color: #eee;
      margin: 0;
      padding: 0;
    }
    .content-wrapper { padding: 20px; }
    h4 { color: #ffcc00; margin-bottom: 20px; text-align: center; }
    .card {
      background: #2c2c2c;
      border-radius: 12px;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .form-label { display: block; margin-bottom: 6px; }
    .form-control, textarea, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #333;
      color: #fff;
      margin-bottom: 15px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-primary { background: #ffcc00; color: #111; }
    .btn-primary:hover { background: #ffaa00; }
    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: 8px;
      font-weight: bold;
      display: none;
    }
    .alert-success { background: #28a745; color: #fff; }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <h4>Cập nhật sản phẩm</h4>
    <div class="card">
      <form id="editProductForm">
        <div class="mb-3">
          <label class="form-label">Tên sản phẩm</label>
          <input type="text" class="form-control" id="name" value="Bánh Kem Dâu" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Thương hiệu</label>
          <select id="id_brands" class="form-control">
            <option value="1" selected>Paris Bakery</option>
            <option value="2">Sweet House</option>
            <option value="3">Tokyo Bakery</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Loại bánh</label>
          <select id="id_categories" class="form-control">
            <option value="1" selected>Bánh kem</option>
            <option value="2">Bánh mì</option>
            <option value="3">Bánh ngọt</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Hình ảnh</label>
          <input type="file" class="form-control" id="image">
          <img src="../uploads/anh6.jpg" alt="Hình ảnh sản phẩm" width="150" style="margin-top:10px;">
        </div>
        <div class="mb-3">
          <label class="form-label">Giá nhập</label>
          <input type="number" class="form-control" id="buy_price" value="150000" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Giá bán</label>
          <input type="number" class="form-control" id="sell_price" value="200000" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Mô tả</label>
          <textarea class="form-control" id="description" rows="3" required>Bánh kem dâu tươi ngon, trang trí đẹp mắt.</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Trạng thái</label>
          <select id="status" class="form-control">
            <option value="1" selected>Hiện</option>
            <option value="0">Ẩn</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Cập nhật</button>
      </form>
    </div>
  </div>

  <!-- Alert -->
  <div id="alertBox" class="alert alert-success">Cập nhật sản phẩm thành công!</div>

<script>
const el = id => document.getElementById(id);
const alertBox = el('alertBox');
function showAlert(msg, ms = 1500){
  if(alertBox){
    alertBox.textContent = msg;
    alertBox.style.display = 'block';
    setTimeout(()=> alertBox.style.display = 'none', ms);
  } else {
    console.log(msg);
  }
}

// Lấy danh sách sản phẩm từ localStorage
let products = JSON.parse(localStorage.getItem("products")) || [];
// Lấy tên sản phẩm đang chọn chỉnh sửa
const editName = localStorage.getItem("editProductName");

// Nếu chưa có sản phẩm để sửa thì quay về danh sách
if(!editName){
  alert("Không tìm thấy sản phẩm để chỉnh sửa!");
  window.location.href = "product_list.html";
}

// Tìm vị trí sản phẩm trong mảng
const productIndex = products.findIndex(p => p && p.name === editName);
const product = products[productIndex] || {};

// Điền dữ liệu vào form
if(el('name')) el('name').value = product.name || '';
if(el('buy_price')) el('buy_price').value = product.import || '';
if(el('sell_price')) el('sell_price').value = product.price || '';
if(el('description')) el('description').value = product.description || '';
if(el('status')) el('status').value = (product.status === "Hiện" ? "1" : "0");

// Điền brand / type nếu có select
if(el('id_brands') && product.brand){
  const opt = Array.from(el('id_brands').options).find(o => o.text === product.brand);
  if(opt) el('id_brands').value = opt.value;
}
if(el('id_categories') && product.type){
  const opt2 = Array.from(el('id_categories').options).find(o => o.text === product.type);
  if(opt2) el('id_categories').value = opt2.value;
}

// Submit form
const form = el('editProductForm');
form.addEventListener('submit', function(e){
  e.preventDefault();

  const name = el('name').value.trim();
  const buy_price = parseInt(el('buy_price').value || 0);
  const sell_price = parseInt(el('sell_price').value || 0);
  const description = el('description').value;
  const statusVal = el('status').value;
  const status = statusVal === "1" ? "Hiện" : "Ẩn";

  let brand = product.brand || '';
  let type = product.type || '';
  if(el('id_brands')) brand = el('id_brands').selectedOptions[0].text;
  if(el('id_categories')) type = el('id_categories').selectedOptions[0].text;

  // Cập nhật sản phẩm trong mảng
  products[productIndex] = {
    ...products[productIndex],
    name,
    brand,
    type,
    import: buy_price,
    price: sell_price,
    description,
    status
  };

  // Lưu lại localStorage
  localStorage.setItem("products", JSON.stringify(products));

  // Đồng bộ statusMap (để danh sách tĩnh ngoài list cũng update theo)
  let statusMap = JSON.parse(localStorage.getItem("statusMap")) || {};
  statusMap[name] = status;
  localStorage.setItem("statusMap", JSON.stringify(statusMap));

  // Hiện thông báo và chuyển trang
  showAlert("Cập nhật sản phẩm thành công!", 1400);

  setTimeout(()=> {
    window.location.href = "product_list.html";
  }, 1300);
});
</script>


</body>
</html>
