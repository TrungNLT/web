<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sản phẩm theo loại</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/font-awesome.min.css" />
  <link rel="stylesheet" href="css/elegant-icons.css" />
  <link rel="stylesheet" href="css/flaticon.css" />
  <link rel="stylesheet" href="css/barfiller.css" />
  <link rel="stylesheet" href="css/magnific-popup.css" />
  <link rel="stylesheet" href="css/nice-select.css" />
  <link rel="stylesheet" href="css/owl.carousel.min.css" />
  <link rel="stylesheet" href="css/slicknav.min.css" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    :root {--orange-50:#fff7f1;--orange-100:#ffe8d6;--orange-150:#ffeedf;--orange-200:#ffd4b0;--orange-300:#ffb374;--orange-400:#ff943d;--orange-500:#ff7a00;--orange-600:#e56700;--orange-700:#c75400;--shadow-soft:0 4px 14px -6px rgba(255,122,0,.45),0 2px 6px -2px rgba(0,0,0,.08);} 
    body {background:linear-gradient(180deg,var(--orange-50),#ffffff 320px) fixed;}
    .primary-btn{background:var(--orange-500);border:none;border-radius:18px;padding:8px 16px;font-size:.75rem;letter-spacing:.5px;color:#fff;}
    .primary-btn:hover{background:var(--orange-600);} 
    /* Filter bar (similar to shop) */
  #filter-bar {display:flex;flex-wrap:wrap;gap:14px;align-items:stretch;padding:14px 18px;margin:0 0 12px; background:linear-gradient(135deg,var(--orange-50),#fff); border:1px solid var(--orange-200); border-radius:18px; box-shadow:0 2px 4px rgba(255,122,0,.18),0 4px 12px -4px rgba(255,122,0,.25);}    
  #filter-bar .filter-left {display:flex;gap:12px;align-items:stretch;flex:1 1 320px;min-width:260px}
  #filter-bar select,#filter-bar input{appearance:none;-webkit-appearance:none;font-size:.9rem;font-weight:500;border:1px solid var(--orange-200);background:#fff;color:#333;line-height:1.2;padding:10px 12px;border-radius:12px;min-height:42px;transition:.18s ease;box-shadow:0 1px 1px rgba(0,0,0,.05);}    
  #filter-bar select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23ff7a00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:34px;}
    /* Price group styling to match shop */
    #filter-bar .price-group{display:flex;align-items:center;gap:8px;flex:0 1 auto;white-space:nowrap;padding:4px 10px 4px 6px;border-radius:14px;background:var(--orange-100);border:1px solid var(--orange-200);position:relative;}
    #filter-bar .price-group:focus-within{box-shadow:0 0 0 3px var(--orange-100);border-color:var(--orange-400);}    
    #filter-bar .price-group input{width:110px;background:transparent;border:1px solid var(--orange-200);}    
    #filter-bar .price-group input:focus{background:#fff;outline:none;border-color:var(--orange-400);}    
    #filter-bar .price-group .price-sep{font-weight:600;color:var(--orange-600);margin:0 4px;}
  #reset-filters{flex:0 0 auto;font-weight:600;letter-spacing:.25px;min-width:68px; margin-left:auto; background:var(--orange-500);color:#fff;border:none;border-radius:12px;padding:10px 16px; line-height:1.1; display:inline-flex;align-items:center;justify-content:center;gap:6px;position:relative;overflow:hidden; transition:background .18s ease, transform .18s ease,box-shadow .18s ease;box-shadow:0 2px 4px rgba(0,0,0,.08),0 4px 10px -4px rgba(255,122,0,.45);} 
  #reset-filters:hover {background:var(--orange-600);transform:translateY(-2px);} 
  #reset-filters:active {background:var(--orange-700);transform:translateY(0);} 
    /* Cards */
    .product-card{border:1px solid #eee;border-radius:16px;overflow:hidden;transition:.25s;background:#fff;height:100%;}
    .product-card:hover{box-shadow:0 6px 18px -6px rgba(255,122,0,.35),0 4px 10px -4px rgba(0,0,0,.08);border-color:var(--orange-300);}            
    .product-card .product__item__pic{border-bottom:1px solid #f2f2f2;min-height:230px;background-size:cover;background-position:center}
    .product-card .product__item__text h6{min-height:48px;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .shop__pagination a{border-radius:12px;min-width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-weight:600;letter-spacing:.3px;border:1px solid var(--orange-200);background:#fff;transition:.25s;margin:0 4px;}
  .shop__pagination a.active,.shop__pagination a:hover{background:var(--orange-500);border-color:var(--orange-500);color:#fff;box-shadow:0 4px 12px -6px rgba(255,122,0,.5);}            
  .shop__pagination {display:flex;flex-wrap:nowrap;align-items:center;justify-content:center;overflow-x:auto;padding:4px 4px;scrollbar-width:none;-ms-overflow-style:none;}
  .shop__pagination::-webkit-scrollbar{display:none;}
  #pagination-container {white-space:nowrap;}
  .shop__option__right {display:flex;align-items:stretch;justify-content:flex-end;gap:10px;}
  #sort-filter {flex:1;min-width:230px;max-width:320px;cursor:pointer; appearance:none;-webkit-appearance:none;font-size:.9rem;font-weight:500; border:1px solid var(--orange-200);background:#fff; color:#333;line-height:1.2; padding:10px 12px;border-radius:12px;min-height:42px;transition:.18s ease;box-shadow:0 1px 1px rgba(0,0,0,.05); background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23ff7a00' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat:no-repeat;background-position:right 12px center;padding-right:36px;}
    /* Category section like shop */
    .category-section{margin-bottom:26px}
    .category-box{background:linear-gradient(135deg,var(--orange-150),#fff7f1);border:1px solid var(--orange-200);border-radius:16px;padding:14px 14px 18px;box-shadow:0 6px 18px -10px rgba(255,122,0,.35),0 4px 10px -6px rgba(0,0,0,.06)}
    .category-header{display:block;text-align:center;color:#111;font-weight:800;letter-spacing:.3px;padding:10px 14px;border:1px solid var(--orange-300);border-radius:12px;margin:2px auto 12px;background:var(--orange-300);max-width:260px;font-family:'Playfair Display',serif}
  .cat-card .product__item{display:flex;flex-direction:column;height:100%}
  .cat-card .product__item__pic{height:240px;min-height:240px;background-size:cover;background-position:center}
  .cat-card .product__item__text{display:flex;flex-direction:column;gap:6px;flex:1}
    .product-card .product__item__text > div:last-child{margin-top:auto}
    /* Buy Now overlay (same as shop) */
    body.bn-no-scroll{overflow:hidden}
    #bn-overlay{position:fixed;inset:0;z-index:9999;display:block;pointer-events:none;}
    #bn-overlay .bn-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);opacity:0;transition:.25s}
    #bn-overlay .bn-sheet{position:absolute;left:0;right:0;bottom:-100%;background:#fff;border-radius:16px 16px 0 0;box-shadow:0 -10px 30px rgba(0,0,0,.2);padding:14px 14px 16px;transition:bottom .25s;max-height:78vh;overflow:auto}
    #bn-overlay.show{pointer-events:auto}
    #bn-overlay.show .bn-backdrop{opacity:1}
    #bn-overlay.show .bn-sheet{bottom:0}
    .bn-close{position:absolute;right:12px;top:8px;border:none;background:transparent;font-size:26px;line-height:1;color:#555;cursor:pointer}
    .bn-head{display:flex;gap:12px;align-items:center}
    .bn-thumb-wrap{position:relative;width:84px;height:84px;border-radius:12px;overflow:hidden;background:#f4f4f4;border:1px solid #eee;flex:0 0 auto}
    .bn-thumb{width:100%;height:100%;background-size:cover;background-position:center}
    .bn-expand{position:absolute;right:6px;top:6px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center;text-decoration:none}
    .bn-meta{display:flex;flex-direction:column;gap:4px}
    .bn-name{font-weight:700}
    .bn-price-stock{display:flex;gap:10px;align-items:center}
    .bn-price{color:#d63031;font-weight:700}
    .bn-stock{color:#666;font-weight:600}
    .bn-body{margin-top:12px}
    .bn-qty-label{display:block;font-size:.8rem;color:#666;margin-bottom:6px;font-weight:600}
    .bn-qty{display:inline-flex;align-items:stretch;border:1px solid #ddd;border-radius:10px;overflow:hidden}
    .bn-qty-btn{background:#f3f3f3;border:none;padding:8px 12px;cursor:pointer;font-weight:700}
    #bn-qty-input{width:70px;text-align:center;border:none}
    .bn-actions{margin-top:14px}
    .bn-submit{width:100%;background:var(--orange-500);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:700}
    .bn-submit:hover{background:var(--orange-600)}
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <div class="breadcrumb-option">
    <div class="container">
      <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6"><div class="breadcrumb__text"><h2>Cửa Hàng</h2></div></div>
        <div class="col-lg-6 col-md-6 col-sm-6"><div class="breadcrumb__links"><a href="./index.html">Trang chủ</a><span>Theo loại</span></div></div>
      </div>
    </div>
  </div>

  <section class="shop spad">
    <div class="container">
      <div class="shop__option">
        <div class="row">
          <div class="col-lg-7 col-md-7">
            <div id="filter-bar" class="shop__option__search">
              <div class="filter-left">
                <select id="category-filter" class="custom-select"></select>
                <input type="text" id="product-search-input" class="form-control" placeholder="Tên sản phẩm...">
              </div>
              <div class="price-group" title="Lọc theo khoảng giá">
                <input type="number" id="min-price" class="form-control" placeholder="Giá từ" min="0" step="1000">
                <span class="price-sep">-</span>
                <input type="number" id="max-price" class="form-control" placeholder="Đến" min="0" step="1000">
              </div>
              <button id="reset-filters" type="button" class="btn btn-sm btn-outline-secondary">Xóa</button>
            </div>
          </div>
          <div class="col-lg-5 col-md-5">
            <div class="shop__option__right">
              <select id="sort-filter" class="custom-select">
                <option value="">Sắp xếp mặc định</option>
                <option value="price_asc">Giá: Thấp đến Cao</option>
                <option value="price_desc">Giá: Cao đến Thấp</option>
                <option value="name_asc">Tên: A đến Z</option>
                <option value="name_desc">Tên: Z đến A</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="row" id="product-grid"></div>

      <div class="shop__last__option">
        <div class="row">
          <div class="col-lg-12">
            <div class="shop__pagination" id="pagination-container"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="footer-placeholder"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/jquery-3.3.1.min.js"><\/script>')</script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/main.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/auth.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const include = (id, file, cb) => fetch(file)
      .then(r=>r.ok?r.text():Promise.reject(file))
      .then(html=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.innerHTML=html;
        // Thực thi các <script> trong fragment để đảm bảo hành vi trên host thật
        el.querySelectorAll('script').forEach(old=>{
          const s=document.createElement('script');
          if(old.src){ s.src=old.src; s.async=false; }
          else { s.textContent=old.textContent||''; }
          if(old.type) s.type=old.type;
          if(old.defer) s.defer=true;
          document.body.appendChild(s);
        });
        cb&&cb();
      })
      .catch(e=>{ console.error('Include lỗi',e); cb&&cb(); });
    // Sync header/cart behaviors like shop
    const updateCartCountInHeader = () => {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      const countEl = document.getElementById('header-cart-count');
      const offEl = document.getElementById('offcanvas-cart-count');
      let c = 0;
      if (user && window.Cart?.getCart) {
        try { c = (Cart.getCart() || []).reduce((s, it) => s + Number(it.qty ?? it.quantity ?? 1), 0); } catch {}
      }
      if (countEl) countEl.textContent = c;
      if (offEl) offEl.textContent = c;
    };
    const updateUserStatus = () => {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      const headerIn = document.getElementById('header-user-loggedin');
      const headerOut = document.getElementById('header-user-loggedout');
      if (user) {
        if (headerIn) headerIn.style.display = 'block';
        if (headerOut) headerOut.style.display = 'none';
        const nameEl = document.getElementById('header-fullname-placeholder');
        if (nameEl) nameEl.textContent = user.fullname;
      } else {
        if (headerIn) headerIn.style.display = 'none';
        if (headerOut) headerOut.style.display = 'block';
      }
    };
    const initUI = () => {
      if ($.fn.slicknav && $(".mobile-menu").length && !$("#mobile-menu-wrap .slicknav_menu").length) {
        $(".mobile-menu").slicknav({ prependTo: '#mobile-menu-wrap', allowParentLinks: true });
      }
      $(".canvas__open").off('click').on('click', function () { $(".offcanvas-menu-wrapper").addClass("active"); $(".offcanvas-menu-overlay").addClass("active"); });
      $(".offcanvas-menu-overlay").off('click').on('click', function () { $(".offcanvas-menu-wrapper").removeClass("active"); $(".offcanvas-menu-overlay").removeClass("active"); });
      $(".search-switch").off('click').on('click', function () { $(".search-model").fadeIn(400); });
  $(".search-close-switch").off('click').on('click', function () { $(".search-model").fadeOut(400, function () { $('.search-model #search-input').val(''); }); });
      $('.set-bg').each(function () { var bg = $(this).data('setbg'); if (bg) { $(this).css('background-image', 'url(' + bg + ')'); } });
      updateCartCountInHeader();
      updateUserStatus();
    };
  let all = [];
  const state = { search:'', sort:'', cat:'', min:'', max:'', page:1, perPage:4 };

    function getURLCat(){ try{ const p=new URLSearchParams(location.search); return p.get('category')||p.get('cat')||''; }catch{return '';} }

    async function load(){ try{ all = await (window.loadProducts ? window.loadProducts() : fetch('database/product.json').then(r=>r.json())); } catch{ all = []; } }

    function renderCategorySelect(){
      const sel = document.getElementById('category-filter');
      const names = Array.from(new Set(all.map(p=>String(p.CategoryName||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  sel.innerHTML = '<option value="">Danh mục</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
      if (state.cat) sel.value = state.cat;
      sel.onchange = (e)=>{ const v=e.target.value; if (v) { state.cat=v; state.page=1; render(); } else { window.location.href='shop.html'; } };
    }

    function applySort(arr){
      switch(state.sort){
        case 'price_asc': return arr.sort((a,b)=>a.SellPrice-b.SellPrice);
        case 'price_desc': return arr.sort((a,b)=>b.SellPrice-a.SellPrice);
        case 'name_asc': return arr.sort((a,b)=>a.Name.localeCompare(b.Name));
        case 'name_desc': return arr.sort((a,b)=>b.Name.localeCompare(a.Name));
        default: return arr.sort((a,b)=>(b.CountView||0)-(a.CountView||0));
      }
    }

    function render(){
      const grid = document.getElementById('product-grid');
      let products = [...all];
      if (state.cat) products = products.filter(p => String(p.CategoryName||'').toLowerCase() === state.cat.toLowerCase());
      if (state.search) products = products.filter(p => p.Name.toLowerCase().includes(state.search.toLowerCase()));
      const min = state.min!==''?Number(state.min):null; const max = state.max!==''?Number(state.max):null;
      if (min!=null && !isNaN(min)) products = products.filter(p => p.SellPrice >= min);
      if (max!=null && !isNaN(max)) products = products.filter(p => p.SellPrice <= max);
      if (min!=null && max!=null && min>max) products = [];
      applySort(products);

      const total = products.length;
      // Empty state message like shop.html (show active conditions)
      if (total === 0) {
        const conds = [];
        if (state.search) conds.push(`tên chứa "${state.search}"`);
        if (state.cat) conds.push(`thuộc loại "${state.cat}"`);
        if (state.min !== '') conds.push(`giá ≥ ${Number(state.min).toLocaleString('vi-VN')} VND`);
        if (state.max !== '') conds.push(`giá ≤ ${Number(state.max).toLocaleString('vi-VN')} VND`);
        grid.innerHTML = `<div class="col-12"><p>Không tìm thấy sản phẩm nào phù hợp${conds.length ? ' với: ' + conds.join(', ') : ''}.</p></div>`;
        document.getElementById('pagination-container').innerHTML='';
        return;
      }

      // Clamp page if out of range after filters change
      const pages = Math.ceil(total / state.perPage);
      if (state.page > pages) state.page = 1;
      const start = (state.page-1)*state.perPage;
      const pageItems = products.slice(start, start+state.perPage);

      const catName = state.cat || 'Danh mục';
      grid.innerHTML = `
        <div class="col-12 category-section">
          <div class="category-box">
            <div class="category-header">${catName}</div>
            <div class="row">
              ${pageItems.map(p=>`
                <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                  <div class="product__item product-card" data-product-id="${p.ProductId}" style="cursor:pointer;">
                    <div class="product__item__pic set-bg" style="background-image:url('${p.Image}')"></div>
                    <div class="product__item__text">
                      <h6><a href="product_detail.html?id=${p.ProductId}">${p.Name}</a></h6>
                      <h5>${p.SellPrice.toLocaleString('vi-VN')} VND</h5>
                      <div>${p.Avaiable_quantity>0 ? `<button class=\"btn primary-btn btn-sm mt-2\" onclick=\"event.stopPropagation();handleAddToCart(${p.ProductId})\">Thêm giỏ hàng</button> <button class=\"btn primary-btn btn-sm mt-2\" onclick=\"event.stopPropagation();handleBuyNow(${p.ProductId})\" style=\"background-color:#28a745;margin-left:5px;\">Mua ngay</button>` : '<span style=\"color:red;font-weight:bold;\">Hết hàng</span>'}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>`;

  const pager = document.getElementById('pagination-container');
  const pages2 = Math.ceil(total/state.perPage);
  pager.innerHTML = Array.from({length: pages2}, (_,i)=>`<a href=\"#\" data-page=\"${i+1}\" class=\"${i+1===state.page?'active':''}\">${i+1}</a>`).join('');

  // No horizontal nav; we render full 4-product grid.
    }

    function attach(){
  document.getElementById('product-search-input').addEventListener('input', e=>{ state.search=e.target.value; state.page=1; render(); });
  document.getElementById('sort-filter').addEventListener('change', e=>{ state.sort=e.target.value; state.page=1; render(); });
      document.getElementById('min-price').addEventListener('input', e=>{ state.min=e.target.value; state.page=1; render(); });
      document.getElementById('max-price').addEventListener('input', e=>{ state.max=e.target.value; state.page=1; render(); });
      document.getElementById('reset-filters').addEventListener('click', ()=>{
        state.search=''; state.sort=''; state.min=''; state.max=''; state.page=1;
  document.getElementById('product-search-input').value='';
        document.getElementById('sort-filter').value='';
        document.getElementById('min-price').value='';
        document.getElementById('max-price').value='';
        render();
      });
      document.getElementById('pagination-container').addEventListener('click', e=>{
        e.preventDefault(); const a = e.target.closest('a'); if(!a) return; state.page=parseInt(a.dataset.page); render(); window.scrollTo(0,0);
      });
      // click card -> detail
      document.getElementById('product-grid').addEventListener('click', e=>{
        const card = e.target.closest('.product-card'); if(!card) return; if(e.target.closest('a,button')) return; const pid = card.getAttribute('data-product-id'); if(pid) window.location.href = 'product_detail.html?id='+pid;
      });

      // Buy Now overlay (same as shop)
      window.handleBuyNow = function (productId) {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) { alert('Vui lòng đăng nhập để mua hàng!'); window.location.href = 'login.html'; return; }
        openBuyNowSheet(Number(productId));
      }
    }

    // Overlay helpers
    function ensureBuyNowOverlay() {
      let ov = document.getElementById('bn-overlay');
      if (ov) return ov;
      ov = document.createElement('div');
      ov.id = 'bn-overlay';
      ov.innerHTML = `
        <div class="bn-backdrop" data-close="1"></div>
        <div class="bn-sheet" role="dialog" aria-modal="true" aria-labelledby="bn-title">
          <button class="bn-close" title="Đóng" aria-label="Đóng">&times;</button>
          <div class="bn-head">
            <div class="bn-thumb-wrap">
              <div id="bn-thumb" class="bn-thumb"></div>
              <a id="bn-expand" class="bn-expand" title="Xem chi tiết" aria-label="Xem chi tiết">&#x2197;</a>
            </div>
            <div class="bn-meta">
              <div id="bn-title" class="bn-name">Sản phẩm</div>
              <div class="bn-price-stock">
                <div id="bn-price" class="bn-price">0 VND</div>
                <div id="bn-stock" class="bn-stock">Kho: 0</div>
              </div>
            </div>
          </div>
          <div class="bn-body">
            <label class="bn-qty-label">Số lượng</label>
            <div class="bn-qty">
              <button id="bn-minus" class="bn-qty-btn" aria-label="Giảm">-</button>
              <input id="bn-qty-input" type="number" min="1" value="1" />
              <button id="bn-plus" class="bn-qty-btn" aria-label="Tăng">+</button>
            </div>
          </div>
          <div class="bn-actions">
            <button id="bn-submit" class="bn-submit">Mua ngay</button>
          </div>
        </div>`;
      document.body.appendChild(ov);
      ov.addEventListener('click', (e) => { if (e.target.classList.contains('bn-backdrop') || e.target.classList.contains('bn-close')) closeBuyNowSheet(); });
      return ov;
    }
    function openBuyNowSheet(productId) {
      const ov = ensureBuyNowOverlay();
      const prod = (all || []).find(p => Number(p.ProductId) === Number(productId));
      if (!prod) { alert('Không tìm thấy sản phẩm'); return; }
      ov.dataset.pid = String(productId);
      const nameEl = ov.querySelector('#bn-title');
      const priceEl = ov.querySelector('#bn-price');
      const stockEl = ov.querySelector('#bn-stock');
      const thumb = ov.querySelector('#bn-thumb');
      const qtyInput = ov.querySelector('#bn-qty-input');
      const minus = ov.querySelector('#bn-minus');
      const plus = ov.querySelector('#bn-plus');
      const submit = ov.querySelector('#bn-submit');
      const expand = ov.querySelector('#bn-expand');
      nameEl.textContent = String(prod.Name || 'Sản phẩm');
      priceEl.textContent = (Number(prod.SellPrice) || 0).toLocaleString('vi-VN') + ' VND';
      const stock = Number(prod.Avaiable_quantity ?? prod.Available_quantity ?? 0) || 0;
      stockEl.textContent = 'Kho: ' + stock;
      thumb.style.backgroundImage = `url('${prod.Image}')`;
      qtyInput.value = '1';
      qtyInput.min = '1';
      qtyInput.max = String(Math.max(1, stock));
      submit.disabled = stock <= 0;
      const clamp = (v) => { let n = Number(v)||1; if(n<1) n=1; if(stock && n>stock) n=stock; return n; };
      minus.onclick = () => { qtyInput.value = String(clamp(Number(qtyInput.value)-1)); };
      plus.onclick = () => { qtyInput.value = String(clamp(Number(qtyInput.value)+1)); };
      qtyInput.oninput = () => { qtyInput.value = String(clamp(qtyInput.value)); };
      expand.onclick = (e) => { e.preventDefault(); window.location.href = `product_detail.html?id=${productId}`; };
      submit.onclick = () => {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (!user) { window.location.href = 'login.html'; return; }
        try { const key = `buynow_items_${user.id}`; const qty = clamp(qtyInput.value); const payload = [{ productId: Number(productId), qty: Number(qty) }]; sessionStorage.setItem(key, JSON.stringify(payload)); } catch {}
        closeBuyNowSheet();
        window.location.href = 'user_order.html';
      };
      requestAnimationFrame(()=>{ ov.classList.add('show'); document.body.classList.add('bn-no-scroll'); });
    }
    function closeBuyNowSheet(){ const ov = document.getElementById('bn-overlay'); if(!ov) return; ov.classList.remove('show'); document.body.classList.remove('bn-no-scroll'); }

    // No horizontal row navigation needed in category page grid layout

    // Init
    let loaded = 0; const afterInclude = ()=>{ loaded++; if (loaded===2) initUI(); };
    await new Promise(res=>include('header-placeholder','inc/header.html',()=>{ afterInclude(); res(); }));
    include('footer-placeholder','inc/footer.html', afterInclude);
    await load();
    state.cat = getURLCat();
    // Breadcrumb giữ nguyên "Cửa Hàng"; tên loại sẽ hiển thị bên dưới trong khung cam
    renderCategorySelect();
    render();
    attach();
    updateCartCountInHeader();
    updateUserStatus();
    window.addEventListener('cartUpdated', updateCartCountInHeader);
    window.addEventListener('authChanged', () => { updateUserStatus(); updateCartCountInHeader(); });
  });
  </script>
</body>
</html>
